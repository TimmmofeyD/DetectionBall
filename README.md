
# Детекция и отслеживание мяча в футболе с использованием YOLO

## Введение

Задача детекции мяча на футбольном поле является ключевой для анализа спортивных видео, особенно матчей по футболу. Реальное время для обнаружения и отслеживания мяча может быть крайне важным для создания автоматических систем анализа матчей, которые помогают тренерам, командам и аналитикам извлекать полезную информацию для улучшения тактики игры и проведения статистического анализа. Данная проблема имеет несколько сложностей, таких как динамика игры, изменяющиеся условия освещения, наличие множества игроков и движение камеры.

## Проблематика

Одной из главных сложностей этой задачи является то, что мяч является небольшим объектом, который может быть скрыт игроками, пересекаться с линиями поля и двигаться на большой скорости. Различные углы съемки и изменения освещения дополнительно усложняют процесс обнаружения и отслеживания. Мяч также может находиться в воздухе или отскакивать от различных поверхностей, что затрудняет предсказание его движения на основе предыдущих кадров.

Использование YOLO и других современных архитектур для детекции объектов значительно улучшает точность обнаружения и отслеживания мяча в условиях реальных матчей, где постоянно разворачиваются сложные динамические сцены.

## Обзор файлов

### `download_data.ipynb`
- **Назначение:** Этот ноутбук используется для загрузки датасета SoccerNet, включающего данные для задачи gamestate-2024.
- **Основные шаги:**
  1. Загрузка данных SoccerNet (тренировочный, валидационный, тестовый и челлендж-сплиты) с помощью `SoccerNetDownloader`.
  2. Сохранение данных в локальной директории для дальнейшей обработки.

### `preprocessing_data.ipynb`
- **Назначение:** Этот ноутбук фокусируется на предварительной обработке загруженных изображений и аннотаций.
- **Основные шаги:**
  1. Нормализация координат ограничивающих рамок в формат YOLO.
  2. Изменение размера изображений до целевого (640x384).
  3. Обработка аннотаций для соответствия новым размерам изображений и обеспечения правильного формата для обучения YOLO.

### `fill_empty.ipynb`
- **Назначение:** Этот ноутбук используется для проверки наличия аннотаций для каждого изображения.
- **Основные шаги:**
  1. Проверка на наличие отсутствующих файлов аннотаций.
  2. Создание пустых файлов аннотаций для изображений, не имеющих аннотаций.

### `display_checking.ipynb`
- **Назначение:** Этот ноутбук позволяет визуально проверять аннотации, наложенные на изображения.
- **Основные шаги:**
  1. Загрузка изображения и соответствующих аннотаций.
  2. Конвертация аннотаций в формате YOLO обратно в координаты изображения.
  3. Отображение изображения с ограничивающими рамками для проверки корректности аннотаций.

### `soccernet_model.ipynb`
- **Назначение:** Этот ноутбук фокусируется на обучении и развертывании модели YOLO для детекции и отслеживания мяча в видеозаписях футбольных матчей.
- **Основные шаги:**
  1. Обучение модели YOLO с использованием данных SoccerNet с различными методами аугментации, такими как перевороты, масштабирование, трансляция, mixup и мозаика.
  2. Отслеживание мяча на последовательности видеокадров.
  3. Визуализация истории обнаружений, рисуя траекторию движения мяча по кадрам.
  4. Сохранение итогового видео с аннотированной траекторией.

### `data.yaml`
- **Назначение:** Этот файл конфигурации определяет структуру данных для обучения модели YOLO. Он содержит пути к изображениям для обучающей, валидационной и тестовой выборок, а также информацию о классах объектов.
- **Основные параметры:**
  - `train`: Путь к изображениям для обучения, установленный на `../train/images`.
  - `val`: Путь к изображениям для валидации, установленный на `../val/images`.
  - `test`: Путь к изображениям для тестирования, установленный на `../test/images`.
  - `nc`: Количество классов, равное 1 (только для мяча).
  - `names`: Список имен классов, в данном случае `['Ball']`.

### Вес модели `yolo11n.pt`
- **Назначение:** Это предобученная модель YOLOv11, которая представляется как самая маленькая версия в серии YOLOv11.
- **Преимущества:** Модель `yolo11n.pt` отличается высокой скоростью инференса, что делает её идеальной для приложений, требующих быстрой обработки видео, таких как отслеживание мяча в реальном времени.

## Установка зависимостей

1. Склонируйте репозиторий или скачайте файлы проекта.
2. Установите необходимые зависимости:
   ```bash
   pip install -r requirements.txt
   ```
3. Загрузите датасет SoccerNet, используя `download_data.ipynb`.

## Обучение модели

Чтобы обучить модель YOLO, следуйте шагам в `soccernet_model.ipynb`, вы можете использовать предобученные веса модели на датасете SoccerNet: `best.pt`.

В данной секции представлены гиперпараметры, используемые для тренировки модели YOLOv11 на наборе данных SoccerNet.

| Параметр         | Значение      | Описание                                                |
|-------------------|---------------|---------------------------------------------------------|
| `data`            | `"data.yaml"` | Путь к файлу конфигурации с метками и путями к данным. |
| `epochs`          | `30`          | Количество эпох для тренировки модели.                  |
| `imgsz`           | `640`         | Размер входных изображений (ширина и высота).          |
| `batch`           | `128`         | Размер батча для тренировки.                            |
| `augment`         | `True`       | Включает аугментацию данных.                           |
| `fliplr`          | `0.5`         | Вертикальное отражение изображений с вероятностью 50%. |
| `scale`           | `0.5`         | Случайное изменение масштаба изображений до 50%.      |
| `translate`       | `0.1`         | Случайное смещение изображения на 10%.                 |
| `mixup`           | `0.2`         | Вероятность применения MixUp аугментации 20%.          |
| `mosaic`          | `1.0`         | Вероятность применения мозаику 100%.                   |
| `hsv_h`           | `0.1`         | Аугментация цветового тона (Hue) в диапазоне 10%.     |
| `hsv_s`           | `0.7`         | Аугментация насыщенности (Saturation) в диапазоне 70%. |
| `hsv_v`           | `0.4`         | Аугментация яркости (Value) в диапазоне 40%.           |
| `close_mosaic`    | `2`           | Количество соседних изображений, используемых в мозайке. |
| `dropout`         | `0.05`        | Вероятность отключения нейронов в слое Dropout (5%).    |
| `plots`           | `True`       | Включает визуализацию графиков во время тренировки.     |
| `device`          | `[0, 1]`     | Указание на использование GPU 0 и 1 для тренировки.      |

## Результаты

После обучения модель YOLO может эффективно обнаруживать и отслеживать мяч в режиме реального времени на видеозаписях матчей. Движение мяча отслеживается по кадрам, и его траектория визуализируется.

## Результат работы алгоритма детекции мяча на видео

![Видео результата модели](./images/output_video.gif)

### Улучшение модели и трекинга мяча

### Постобработка

- **Метод нон-максимум подавления (NMS)**: Использовать метод нон-максимум подавления, чтобы удалить дублирующиеся предсказания в одной и той же рамке, если они пересекаются. Это поможет повысить точность обнаружения объектов.

- **Kalman Filter**: Использование фильтра Калмана для более плавного трекинга объектов между кадрами. Фильтр поможет предсказать положение объекта в следующем кадре, что может улучшить стабильность трекинга.

### Улучшение трекинга мяча

- **История трекинга**: Вместо использования фиксированного размера для хранения истории трекинга (например, 60 кадров), можно рассмотреть возможность хранения всех точек и использовать методы сглаживания, такие как фильтры Савицкого-Голея или сглаживание по среднему значению, чтобы уменьшить шум в данных трекинга.

- **Сравнение идентификаторов**: Использовать дополнительный алгоритм, чтобы определить, является ли текущая позиция объекта близкой к предыдущей позиции, прежде чем менять идентификатор.

- **Фильтрация ложных срабатываний**: Добавить механизм для игнорирования объектов, которые наблюдаются в пределах определенного порога (например, 10 кадров), чтобы избежать случайных ложных срабатываний. Это поможет улучшить стабильность и надежность трекинга.

## Заключение

Этот проект демонстрирует мощь современных методов детекции объектов, таких как YOLO, для решения сложных задач видеоанализа, таких как детекция мяча в футболе. Используя методы аугментации данных и дообучение, можно достичь высокой точности даже в сложных сценариях.
